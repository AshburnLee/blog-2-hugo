<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Jenkins | Junhui&#39;s Journal 2</title>
<meta name="keywords" content="jenkins, CICD">
<meta name="description" content="tutorial


Pipline &amp; jenkinsfile 手册：https://www.jenkins.io/doc/book/pipeline/getting-started/


提供的全局变量 env.: &lt;Jenkins master的地址&gt;/pipeline-syntax/globals#env


pipline 实例：https://www.jenkins.io/doc/pipeline/examples/


尽可能应用Jenkins提供的命令，而不是一股脑儿使用shell脚本
比如，git clone，使用：
checkout scmGit(branches: [[name: params.BRANCH]],
                extensions: [],
                userRemoteConfigs: [[credentialsId: params.GITHUB_CREDENTIAL, url: &#39;https://github.com/xxx.git&#39;]])
jenkins是面向过程的，对于任务配置，多考虑使用表驱动
Pipline 中访问 env 变量
stage(){
    println &#34;WORKSPACE: ${env.WORKSPACE}&#34;
    echo env.WORKSPACE
    echo WORKSPACE
}
环境变量可以通过 Groovy 代码访问，方式为 env.VARNAME 或者直接使用 VARNAME。你也可以修改这些属性，但只能通过使用 env. 前缀来写入。所以：

jenkins job 中有保留的 env 变量，避免疑惑这些变量要加上 env.。
env 变量即使在机器上设定了，也是可以修改的。

groovy中的数学计算
def number = 243  // 要计算的数
def fifthRoot = number ** (1.0/5)  // 计算5次方根
两种pipline
在Jenkins中，有两种主要类型的Pipeline：Scripted Pipeline 和 Declarative Pipeline。

Scripted Pipeline【我的工作中都是这种的脚本】:


使用Groovy语法编写，允许更灵活的流程控制和自定义逻辑。
通过node和stage等关键字来定义流水线的执行节点和阶段。
可以直接编写Groovy脚本来构建流水线。


Declarative Pipeline:


使用更结构化的语法，更易于阅读和维护。
通过pipeline、agent、stages等关键字来定义流水线的结构和执行环境。
提供了更丰富的语法来定义构建、部署和测试等阶段。

jenkins 中如何在多个 NODE 并行执行任务
def parallel_tasks = [:]
if (params.GPU_TASK) {
    parallel_tasks[&#34;GPU_TASK&#34;] = {
        node(params.GPU_NODE) {
            stage(){}
            ...
        }
    }
}
if (params.CPU_TASK) {
    parallel_tasks[&#34;CPU_TASK&#34;] = {
        node(params.CPU_NODE) {
            stage(){}
            ...
        }
    }
}

parallel(parallel_tasks)
Elvis 操作符 ?:
这两句句话有什么不同：">
<meta name="author" content="">
<link rel="canonical" href="https://ashburnLee.github.io/blog-2-hugo/jenkins/">
<link crossorigin="anonymous" href="/blog-2-hugo/assets/css/stylesheet.bdaf5941cb3c05e36e857d9e2953ba0c4485ba7bc2da15db169d66a77cbc7a87.css" integrity="sha256-va9ZQcs8BeNuhX2eKVO6DESFunvC2hXbFp1mp3y8eoc=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://ashburnLee.github.io/blog-2-hugo/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ashburnLee.github.io/blog-2-hugo/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://ashburnLee.github.io/blog-2-hugo/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://ashburnLee.github.io/blog-2-hugo/apple-touch-icon.png">
<link rel="mask-icon" href="https://ashburnLee.github.io/blog-2-hugo/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://ashburnLee.github.io/blog-2-hugo/jenkins/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" id="MathJax-script" async></script>


<meta property="og:url" content="https://ashburnLee.github.io/blog-2-hugo/jenkins/">
  <meta property="og:site_name" content="Junhui&#39;s Journal 2">
  <meta property="og:title" content="Jenkins">
  <meta property="og:description" content="tutorial Pipline &amp; jenkinsfile 手册：https://www.jenkins.io/doc/book/pipeline/getting-started/
提供的全局变量 env.: &lt;Jenkins master的地址&gt;/pipeline-syntax/globals#env
pipline 实例：https://www.jenkins.io/doc/pipeline/examples/
尽可能应用Jenkins提供的命令，而不是一股脑儿使用shell脚本 比如，git clone，使用：
checkout scmGit(branches: [[name: params.BRANCH]], extensions: [], userRemoteConfigs: [[credentialsId: params.GITHUB_CREDENTIAL, url: &#39;https://github.com/xxx.git&#39;]]) jenkins是面向过程的，对于任务配置，多考虑使用表驱动 Pipline 中访问 env 变量 stage(){ println &#34;WORKSPACE: ${env.WORKSPACE}&#34; echo env.WORKSPACE echo WORKSPACE } 环境变量可以通过 Groovy 代码访问，方式为 env.VARNAME 或者直接使用 VARNAME。你也可以修改这些属性，但只能通过使用 env. 前缀来写入。所以：
jenkins job 中有保留的 env 变量，避免疑惑这些变量要加上 env.。 env 变量即使在机器上设定了，也是可以修改的。 groovy中的数学计算 def number = 243 // 要计算的数 def fifthRoot = number ** (1.0/5) // 计算5次方根 两种pipline 在Jenkins中，有两种主要类型的Pipeline：Scripted Pipeline 和 Declarative Pipeline。
Scripted Pipeline【我的工作中都是这种的脚本】: 使用Groovy语法编写，允许更灵活的流程控制和自定义逻辑。 通过node和stage等关键字来定义流水线的执行节点和阶段。 可以直接编写Groovy脚本来构建流水线。 Declarative Pipeline: 使用更结构化的语法，更易于阅读和维护。 通过pipeline、agent、stages等关键字来定义流水线的结构和执行环境。 提供了更丰富的语法来定义构建、部署和测试等阶段。 jenkins 中如何在多个 NODE 并行执行任务 def parallel_tasks = [:] if (params.GPU_TASK) { parallel_tasks[&#34;GPU_TASK&#34;] = { node(params.GPU_NODE) { stage(){} ... } } } if (params.CPU_TASK) { parallel_tasks[&#34;CPU_TASK&#34;] = { node(params.CPU_NODE) { stage(){} ... } } } parallel(parallel_tasks) Elvis 操作符 ?: 这两句句话有什么不同：">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:published_time" content="2025-08-31T12:57:45+08:00">
    <meta property="article:modified_time" content="2025-08-31T12:57:45+08:00">
    <meta property="article:tag" content="Jenkins">
    <meta property="article:tag" content="CICD">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jenkins">
<meta name="twitter:description" content="tutorial


Pipline &amp; jenkinsfile 手册：https://www.jenkins.io/doc/book/pipeline/getting-started/


提供的全局变量 env.: &lt;Jenkins master的地址&gt;/pipeline-syntax/globals#env


pipline 实例：https://www.jenkins.io/doc/pipeline/examples/


尽可能应用Jenkins提供的命令，而不是一股脑儿使用shell脚本
比如，git clone，使用：
checkout scmGit(branches: [[name: params.BRANCH]],
                extensions: [],
                userRemoteConfigs: [[credentialsId: params.GITHUB_CREDENTIAL, url: &#39;https://github.com/xxx.git&#39;]])
jenkins是面向过程的，对于任务配置，多考虑使用表驱动
Pipline 中访问 env 变量
stage(){
    println &#34;WORKSPACE: ${env.WORKSPACE}&#34;
    echo env.WORKSPACE
    echo WORKSPACE
}
环境变量可以通过 Groovy 代码访问，方式为 env.VARNAME 或者直接使用 VARNAME。你也可以修改这些属性，但只能通过使用 env. 前缀来写入。所以：

jenkins job 中有保留的 env 变量，避免疑惑这些变量要加上 env.。
env 变量即使在机器上设定了，也是可以修改的。

groovy中的数学计算
def number = 243  // 要计算的数
def fifthRoot = number ** (1.0/5)  // 计算5次方根
两种pipline
在Jenkins中，有两种主要类型的Pipeline：Scripted Pipeline 和 Declarative Pipeline。

Scripted Pipeline【我的工作中都是这种的脚本】:


使用Groovy语法编写，允许更灵活的流程控制和自定义逻辑。
通过node和stage等关键字来定义流水线的执行节点和阶段。
可以直接编写Groovy脚本来构建流水线。


Declarative Pipeline:


使用更结构化的语法，更易于阅读和维护。
通过pipeline、agent、stages等关键字来定义流水线的结构和执行环境。
提供了更丰富的语法来定义构建、部署和测试等阶段。

jenkins 中如何在多个 NODE 并行执行任务
def parallel_tasks = [:]
if (params.GPU_TASK) {
    parallel_tasks[&#34;GPU_TASK&#34;] = {
        node(params.GPU_NODE) {
            stage(){}
            ...
        }
    }
}
if (params.CPU_TASK) {
    parallel_tasks[&#34;CPU_TASK&#34;] = {
        node(params.CPU_NODE) {
            stage(){}
            ...
        }
    }
}

parallel(parallel_tasks)
Elvis 操作符 ?:
这两句句话有什么不同：">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Jenkins",
      "item": "https://ashburnLee.github.io/blog-2-hugo/jenkins/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Jenkins",
  "name": "Jenkins",
  "description": "tutorial Pipline \u0026amp; jenkinsfile 手册：https://www.jenkins.io/doc/book/pipeline/getting-started/\n提供的全局变量 env.: \u0026lt;Jenkins master的地址\u0026gt;/pipeline-syntax/globals#env\npipline 实例：https://www.jenkins.io/doc/pipeline/examples/\n尽可能应用Jenkins提供的命令，而不是一股脑儿使用shell脚本 比如，git clone，使用：\ncheckout scmGit(branches: [[name: params.BRANCH]], extensions: [], userRemoteConfigs: [[credentialsId: params.GITHUB_CREDENTIAL, url: \u0026#39;https://github.com/xxx.git\u0026#39;]]) jenkins是面向过程的，对于任务配置，多考虑使用表驱动 Pipline 中访问 env 变量 stage(){ println \u0026#34;WORKSPACE: ${env.WORKSPACE}\u0026#34; echo env.WORKSPACE echo WORKSPACE } 环境变量可以通过 Groovy 代码访问，方式为 env.VARNAME 或者直接使用 VARNAME。你也可以修改这些属性，但只能通过使用 env. 前缀来写入。所以：\njenkins job 中有保留的 env 变量，避免疑惑这些变量要加上 env.。 env 变量即使在机器上设定了，也是可以修改的。 groovy中的数学计算 def number = 243 // 要计算的数 def fifthRoot = number ** (1.0/5) // 计算5次方根 两种pipline 在Jenkins中，有两种主要类型的Pipeline：Scripted Pipeline 和 Declarative Pipeline。\nScripted Pipeline【我的工作中都是这种的脚本】: 使用Groovy语法编写，允许更灵活的流程控制和自定义逻辑。 通过node和stage等关键字来定义流水线的执行节点和阶段。 可以直接编写Groovy脚本来构建流水线。 Declarative Pipeline: 使用更结构化的语法，更易于阅读和维护。 通过pipeline、agent、stages等关键字来定义流水线的结构和执行环境。 提供了更丰富的语法来定义构建、部署和测试等阶段。 jenkins 中如何在多个 NODE 并行执行任务 def parallel_tasks = [:] if (params.GPU_TASK) { parallel_tasks[\u0026#34;GPU_TASK\u0026#34;] = { node(params.GPU_NODE) { stage(){} ... } } } if (params.CPU_TASK) { parallel_tasks[\u0026#34;CPU_TASK\u0026#34;] = { node(params.CPU_NODE) { stage(){} ... } } } parallel(parallel_tasks) Elvis 操作符 ?: 这两句句话有什么不同：\n",
  "keywords": [
    "jenkins", "CICD"
  ],
  "articleBody": "tutorial Pipline \u0026 jenkinsfile 手册：https://www.jenkins.io/doc/book/pipeline/getting-started/\n提供的全局变量 env.: /pipeline-syntax/globals#env\npipline 实例：https://www.jenkins.io/doc/pipeline/examples/\n尽可能应用Jenkins提供的命令，而不是一股脑儿使用shell脚本 比如，git clone，使用：\ncheckout scmGit(branches: [[name: params.BRANCH]], extensions: [], userRemoteConfigs: [[credentialsId: params.GITHUB_CREDENTIAL, url: 'https://github.com/xxx.git']]) jenkins是面向过程的，对于任务配置，多考虑使用表驱动 Pipline 中访问 env 变量 stage(){ println \"WORKSPACE: ${env.WORKSPACE}\" echo env.WORKSPACE echo WORKSPACE } 环境变量可以通过 Groovy 代码访问，方式为 env.VARNAME 或者直接使用 VARNAME。你也可以修改这些属性，但只能通过使用 env. 前缀来写入。所以：\njenkins job 中有保留的 env 变量，避免疑惑这些变量要加上 env.。 env 变量即使在机器上设定了，也是可以修改的。 groovy中的数学计算 def number = 243 // 要计算的数 def fifthRoot = number ** (1.0/5) // 计算5次方根 两种pipline 在Jenkins中，有两种主要类型的Pipeline：Scripted Pipeline 和 Declarative Pipeline。\nScripted Pipeline【我的工作中都是这种的脚本】: 使用Groovy语法编写，允许更灵活的流程控制和自定义逻辑。 通过node和stage等关键字来定义流水线的执行节点和阶段。 可以直接编写Groovy脚本来构建流水线。 Declarative Pipeline: 使用更结构化的语法，更易于阅读和维护。 通过pipeline、agent、stages等关键字来定义流水线的结构和执行环境。 提供了更丰富的语法来定义构建、部署和测试等阶段。 jenkins 中如何在多个 NODE 并行执行任务 def parallel_tasks = [:] if (params.GPU_TASK) { parallel_tasks[\"GPU_TASK\"] = { node(params.GPU_NODE) { stage(){} ... } } } if (params.CPU_TASK) { parallel_tasks[\"CPU_TASK\"] = { node(params.CPU_NODE) { stage(){} ... } } } parallel(parallel_tasks) Elvis 操作符 ?: 这两句句话有什么不同：\nApple = Banana ?: \"\" Apple = Banana ? Banana : \"\" 两者操作符不同，?: 是Elvis操作符，表示如果Banana不是null或空，则将其值赋给Apple，否则Apple将会是空字符串。两者效果相同。\n关于proxy jenkins服务中写死的 proxy 会影响 groovy 的函数，但是在sh中的执行 你依然可以使用自己的proxy。\n使用Groovy语法创建并写入Python脚本 // Python脚本的内容 def pythonScriptContent = ''' print(\"Hello from Jenkins Pipeline!\") # Add more Python code here ''' // 将内容写入Python脚本文件 writeFile file: 'script.py', text: pythonScriptContent // 执行Python脚本 sh 'python script.py' def createPythonScript() { def scriptName = sh(script: 'echo \\'print(\"Hello, world!\")\\' \u003e example.py', returnStdout: true).trim() return scriptName } node { stage('Create Python Script') { def scriptName = createPythonScript() echo \"Created Python script: ${scriptName}\" } stage('Other Stage') { def scriptName = createPythonScript() // 在这里可以使用创建的Python脚本 } } jenkins 文件归档 如果在Jenkins上使用archiveArtifacts将生成的文件归档，即使在归档后删除了该文件，你仍然可以从Jenkins上访问该log文件，这是因为Jenkins将文件存档在特定的位置，而不是直接引用原始文件。当您使用 archiveArtifacts 步骤归档文件时，Jenkins将文件复制到其构建存档目录中，通常是Jenkins服务器上的特定位置。\n通过页面的\"Artifacts\"或类似的部分，通常会提供一个链接或按钮，使您可以直接下载或查看归档的文件。注意，归档的文件会占用磁盘空间，因此建议在需要时删除归档的文件，以便释放磁盘空间。您可以在Jenkins的配置中调整构建存档的策略和保留期限，以满足您的需求。\ncsv += ... // 构建CSV文件内容 writeFile file: \"result.csv\", text: csv archiveArtifacts 'result.csv' writeFile file: 'run_ut.sh', text: ''' #!/bin/bash set -ex export CI_CACHE=/ci_cache export SC_HOME=/AI export CI_HOME=/AI/3rdparty/AI-ci bash $CI_HOME/run_gcc_latest.sh ''' withCredentials([gitUsernamePassword(credentialsId: params.GITHUB_CREDENTIAL, gitToolName: 'Default')]) { sh \"bash scripts/ci/checkout.sh\" } ... sh \"\"\" sh ./run_ut.sh \"\"\" // 上文创建文件，这里执行 访问 已经归档的 文件，访问已有的 job 已有的 build copyArtifacts filter: '*', fingerprintArtifacts: true, projectName: 'Triton_Release', selector: specific(env.IPEX_BUILD_NUMBER) import hudson.model.* import jenkins.model.* def jobName = \"my-job\" // 作业名称 def buildNumber = 42 // 构建号 def job = Jenkins.instance.getItem(jobName) def build = job.getBuildByNumber(buildNumber) if (build != null) { def artifacts = build.artifacts artifacts.each { artifact -\u003e def fileName = artifact.fileName def relativePath = artifact.relativePath println(\"File: $fileName, Path: $relativePath\") } } else { println(\"Build $buildNumber not found for job $jobName.\") } groovy中使用 .each 循环 遍历一个 map，在遍历中进行 if 判断 data.each { model, modes -\u003e println(model + \":\") modes.each { mode, types -\u003e println(\"\\t\" + mode + \":\") types.each { type -\u003e if (type == 'int8') { println(\"\\t\\t\" + type + \" (optimized)\") } else { println(\"\\t\\t\" + type) } } } } publich HTML report dir('result') { copyArtifacts filter: '*_perf.log', fingerprintArtifacts: true, projectName: 'Complex_fusion', selector: specific(env.RESULT_NUMBER) sh \"touch conv_block.log mha.log mlp.log misc.log\" } dir('baseline') { copyArtifacts filter: '*_perf.log', fingerprintArtifacts: true, projectName: 'Complex_fusion', selector: specific(env.BASELINE_NUMBER) sh \"touch conv_block.log mha.log mlp.log misc.log\" } // generate report for each model for (workload in [\"conv_block\", \"mha\", \"mlp\", \"misc\"]) { def accumulate_min = 1; def count_min = 0; def accumulate_avg = 1; def count_avg = 0; def summary = \"\"; summary += \"\"; summary += \"\\n\"; summary += \"\" + \"Case\" + \"Result Min\" + \"Result Avg\" + \"Baseline Min\" + \"Baseline Avg\" + \"Ratio Min\" + \"Ratio Avg\" + \"\\n\"; // make sure the log file exists sh \"touch result/${workload}.log baseline/${workload}.log\" def res = parse_result(\"result/${workload}.log\"); def base = parse_result(\"baseline/${workload}.log\"); // loop each entry in the result // line [case,min,avg] =\u003e result {case: [min,avg]} for (entry in res) { def case_name = entry.key; def perf_min = entry.value[0]; def perf_avg = entry.value[1]; def base_perf_min = 0.0; def base_perf_avg = 0.0; // find the base if (base.containsKey(case_name)) { base_perf_min = base[case_name][0]; base_perf_avg = base[case_name][1]; } def ratio_min = \"/\"; def css_class_min = \"na\"; if (base_perf_min != 0) { def res0 = compare(perf_min, base_perf_min, ratio_min); css_class_min = res0[0] ratio_min = res0[1] } if (ratio_min != \"/\" \u0026\u0026 ratio_min != \"0.0\") { accumulate_min *= ratio_min.toDouble(); count_min += 1; } def ratio_avg = \"/\"; def css_class_avg = \"na\"; if (base_perf_avg != 0) { def res1 = compare(perf_avg, base_perf_avg, ratio_avg); css_class_avg = res1[0] ratio_avg = res1[1] } if (ratio_avg != \"/\" \u0026\u0026 ratio_avg != \"0.0\") { accumulate_avg *= ratio_avg.toDouble(); count_avg += 1; } summary += \"\" + \"${case_name}\" + \"${perf_min}\" + \"${perf_avg}\" + \"${base_perf_min}\" + \"${base_perf_avg}\" + \"${ratio_min}\" + \"${ratio_avg}\" + \"\\n\"; } def geomean_min def geomean_avg if (count_min \u003e 0) {geomean_min = accumulate_min ** (1.0/count_min);} if (count_avg \u003e 0) {geomean_avg = accumulate_avg ** (1.0/count_avg);} def css_geo_min = up_or_down(geomean_min) def css_geo_avg = up_or_down(geomean_avg) summary += \"\" + \"Geomean\" + \"\" + \"\" + \"\" + \"\" + \"${geomean_min}\" + \"${geomean_avg}\" + \"\\n\"; summary += \"\\n\"; summary += \"\\n\"; dir('summary') { // 生成两个文件，html（内容）和css（格式）， writeFile file: \"perf_test.css\", text: \"\" + \".upgrade {background: lightgreen;}\\n\" + \".downgrade {background: pink;}\\n\" + \".na {background: lightgrey;}\\n\" + \".value {text-align: right;}\\n\" + \".cases {width: 500px;}\\n\" + \".geomean {border: #333333; background: rgb(172, 206, 240);}\" + \".column {width: 100px;}\\n\"; writeFile file: \"${workload}.html\", text: summary } } publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'summary', reportFiles: 'conv_perf.html,mha.html,mlp.html,misc.html', reportName: 'PERF Report', reportTitles: '', useWrapperFileDirectly: true]) Jenkins 脚本一般结构 import org.jenkinsci.plugins.pipeline.modeldefinition.Utils node(params.NODE) { def conda_env = pwd() + \"/conda_llm\"; withEnv([ 'HTTP_PROXY=http://xxx.com:912', 'HTTPS_PROXY=http://xxx.com:912', \"CMAKE_PREFIX_PATH=${conda_env}\", \"MALLOC_CONF=oversize_threshold:1,background_thread:true,metadata_thp:auto,dirty_decay_ms:9000000000,muzzy_decay_ms:9000000000\", \"_CONSTANT_CACHE=1\", \"_GRAPH_CONSTANT_TENSOR_CACHE_CAPACITY=cpu:-1\", \"_DISABLE_COMPILER_BACKEND=${params.DISABLE_COMPILER}\", \"VERBOSE=${param.VERBOSE}\" ]) { stage('setup \u0026 run') { deleteDir(); dir('llm') { checkout scmGit(branches: [[name: params.BRANCH]], extensions: [], userRemoteConfigs: [[credentialsId: params.GITHUB_CREDENTIAL, url: 'https://github.com/xxx.git']]) copyArtifacts filter: '*', fingerprintArtifacts: true, projectName: 'YYY_Release', selector: specific(env.IPEX_BUILD_NUMBER) retry(5) { sh \"conda create --prefix ${conda_env} --file requirements.txt -c conda-forge python=3.10 -y\" } retry(5) { sh \"conda install --prefix ${conda_env} jemalloc -y\" } dir('examples/cpu/inference/python/llm'){ sh \"\"\" bash ./tools/env_setup.sh 7 source ./tools/env_activate.sh source activate ${conda_env} python run.py \"\"\" } } sh \"\"\" source activate ${conda_env} ... pip install ${params.PYTORCH_URL} --no-deps pip install *.whl --no-deps pip install -r requirements.txt \"\"\" } withEnv([ \"MALLOC_CONF=oversize_threshold:1,background_thread:true,metadata_thp:auto,dirty_decay_ms:9000000000,muzzy_decay_ms:9000000000\", \"_CONSTANT_CACHE=1\", \"GRAPH_CONSTANT_TENSOR_CACHE_CAPACITY=cpu:-1\", \"_DISABLE_COMPILER_BACKEND=${params.DISABLE_COMPILER}\", \"VERBOSE=${param.VERBOSE}\" ]) { stage('run llm') { dir('vision') { checkout scmGit(branches: [[name: 'master']], extensions: [], userRemoteConfigs: [[credentialsId: params.GITHUB_CREDENTIAL, url: 'https://github.com/xxx.git']]) sh \"\"\" source activate ${conda_env} ... \"\"\" for (dt in [\"int8_ipex\"]) { sh \"\"\" source activate ${conda_env} bash run_test.sh all ${dt} ${params.mode} int8_ipex \"\"\" } sh \"\"\" cp logs/summary.log ./vision.log \"\"\" archiveArtifacts 'vision.log' } } } } } 坑：shell的带特殊符号的环境变量 withEnv([\"CACHE_CAPACITY=cpu:10240;gpu:20480\", \"CACHE_CAPACITY_2='cpu:10240;gpu:20480'\", \"CACHE_CAPACITY_3=\\\"cpu:10240;gpu:20480\\\"\"]){ echo env.CACHE_CAPACITY; // cpu:10240;gpu:20480 v echo env.CACHE_CAPACITY_2; // 'cpu:10240;gpu:20480' x echo env.CACHE_CAPACITY_3; // \"cpu:10240;gpu:20480\" x sh\"\"\" export CACHE_CAPACITY_4=\"cpu:10240;gpu:20480\" echo \\${CACHE_CAPACITY} ## cpu:10240;gpu:20480 v echo \\${CACHE_CAPACITY_2} ## 'cpu:10240;gpu:20480' x echo \\${CACHE_CAPACITY_3} ## \"cpu:10240;gpu:20480\" x echo \\${CACHE_CAPACITY_4} ## cpu:10240;gpu:20480 v \"\"\" } withEnv 中变量的值，不加双引号！\n坑：jenkins 中的用户访问不到 GPU 在机器上给用户访问权限后，直接在机器上是可以访问，但是jenkins的pipline中相同的用户还是不能访问。\n答：jenkins系统上需要重启机器，后就可以了 jenkins上的agent其实是一直运行 的，可以理解成jenkins系统中这个shell从来没有变过，重启才生效\n坑：’’ vs \"\" 在Groovy中，’’ 和 \"\" 都表示空字符串，它们在功能上是等价的。因此，在my_list.add('')和my_list.add(\"\")这两行代码中，它们的作用是相同的，都是向my_list中添加一个空字符串。 Groovy允许使用单引号或双引号来表示字符串，这两种表示方法在大多数情况下是可以互换使用的。\n坑：withEnv()的参数是一个List，其内容可以是空但必须要给一个List 对象 jenkins 报错：hudson.remoting.ProxyException: java.lang.NullPointerException: Cannot invoke “java.util.List.iterator()” because “overrides” is null\n坑：withEnv([]) jenkins 报错：process apparently never started in … 答：检查withEnv中的环境变量是否符合预期。注意要在sh中检查环境变量的值，最好将所有的 env 输出到文件并且archive起来，便于检查\n坑：shell 的 pid 不同的 sh \"\"\" “”\", 之间的 pid 不相同，不共用环境，包括conda环境。如果要公用，则需要通过 withEnv添加\n坑：sh \"\"\" vd sh ’'' sh \"\"\" 中的变量要是 jenkins 脚本的变量， 先获取变量值，替换后，再执行shell sh ’’’ 中变量是 shell 脚本自身的变量， 直接执行shell\n坑：案例分析 sh (script: \"\"\" source ~/miniconda3/etc/profile.d/conda.sh if [ \"\\$(conda info --env | grep ${CONDA_ENV} | wc -l )\" == \"0\" ];then conda create -n ${CONDA_ENV} python=3.10 openpyxl csv -y fi conda activate ${CONDA_ENV} bash ${WORKSPACE}/tools/bdnn/jenkins_utils/collect_result.sh ${cfg[2]}_perf.log perf.log python ${WORKSPACE}/tools/bdnn/jenkins_utils/to_excel.py perf.log ${cfg[2]}_perf.xlsx \"\"\", returnStdout: true) if 条件中 \"\\$(conda info --env...\" 的第一个$, 需要转义，告诉 jenkins 不要替换 $后的内容，其他jenkins变量替换之后，这个$作为shell脚本的内容执行。\n坑：访问函数参数 sh\"\"\" vs sh’’’ 两者区别 def Select_Model(direction, dtype) { println(\"======inside of Select()=====\u003e\" + direction) sh''' echo \"------ \u003e $direction\" ''' } 上面函数中变量direction 为什么在sh中访问不到，echo得到是空？\n改为一下就可以：\ndef Select_Model(direction, dtype) { println(\"======inside of Select()=====\u003e\" + direction) sh\"\"\" echo \"------ \u003e ${direction}\" // allows for string interpolation, 先获取direction值，后执行shell \"\"\" } 因为 sh\"\"\" 里通过 $ 来获取groovy的变量，如上例，$direction 获取函数参数的值替换后，执行shell。而sh''' 里边不能获取groovy变量的值，只能通过 withEnv 的方式间接获取，所以如果要使用 sh''' 那么应改为：\ndef Select_Model(direction, dtype) { withEnv([\"Direction=${direction}\"]) { println(\"======inside of Select()=====\u003e\" + direction) sh''' echo \"------ \u003e ${Direction}\" // 不会string interpolation, 原样输出，后执行shell，此时Direction已经是个环境变量了 ''' } } 坑：dir () 在Jenkins中，dir('${MY}')[错误] 和 dir(\"${MY}\")[正确] 之间的主要区别在于引号的类型。单引号和双引号在Groovy中有不同的用途：\ndir('${MY}') 使用了单引号，这意味着${MY}不会被解释为变量，而会被视为普通的字符串。这将导致Jenkins尝试切换到一个名为 ${MY} 的目录，而不是切换到环境变量 MY 的值所表示的目录。因此，这种写法通常不会达到预期的效果，除非您确实有一个名为${MY}的目录。\ndir(\"${MY}\") 使用了双引号，这意味着${MY}会被解释为变量，并用其值替换。如果环境变量 MY 的值是一个有效的目录路径，那么Jenkins会尝试切换到这个目录。\n所以，一般情况下，如果您希望在dir命令中引用一个环境变量的值作为目录路径，应该使用双引号，如dir(\"${MY}\")。这将使Jenkins正确地解释${MY}作为变量，并使用它的值作为目录路径\n所以，Jenkins中没有特殊理由，都是用双引号 \"\"\" 。\n坑：方法不可用 默认情况下，许多敏感方法是被禁止的，以确保Jenkins的安全性。当您在Jenkins中执行Groovy脚本时，可能会遇到安全限制，例如 “Scripts not permitted to use method” 的错误消息。这是由于Jenkins的脚本安全性设置所引起的。\nAdminister Jenkins 权限的用户可以配置 Jenkins 的脚本安全性设置，以允许或拒绝特定方法的使用。\n",
  "wordCount" : "1275",
  "inLanguage": "en",
  "datePublished": "2025-08-31T12:57:45+08:00",
  "dateModified": "2025-08-31T12:57:45+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ashburnLee.github.io/blog-2-hugo/jenkins/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Junhui's Journal 2",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ashburnLee.github.io/blog-2-hugo/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ashburnLee.github.io/blog-2-hugo/" accesskey="h" title="Junhui&#39;s Journal 2 (Alt + H)">Junhui&#39;s Journal 2</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ashburnLee.github.io/blog-2-hugo/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://ashburnLee.github.io/blog-2-hugo/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://ashburnLee.github.io/blog-2-hugo/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Jenkins
    </h1>
    <div class="post-meta"><span title='2025-08-31 12:57:45 +0800 CST'>August 31, 2025</span>

</div>
  </header> 
  <div class="post-content"><h2 id="tutorial">tutorial<a hidden class="anchor" aria-hidden="true" href="#tutorial">#</a></h2>
<ol>
<li>
<p>Pipline &amp; jenkinsfile 手册：https://www.jenkins.io/doc/book/pipeline/getting-started/</p>
</li>
<li>
<p>提供的全局变量 <code>env.</code>: <code>&lt;Jenkins master的地址&gt;/pipeline-syntax/globals#env</code></p>
</li>
<li>
<p>pipline 实例：https://www.jenkins.io/doc/pipeline/examples/</p>
</li>
</ol>
<h2 id="尽可能应用jenkins提供的命令而不是一股脑儿使用shell脚本">尽可能应用Jenkins提供的命令，而不是一股脑儿使用shell脚本<a hidden class="anchor" aria-hidden="true" href="#尽可能应用jenkins提供的命令而不是一股脑儿使用shell脚本">#</a></h2>
<p>比如，git clone，使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>checkout <span style="color:#a6e22e">scmGit</span><span style="color:#f92672">(</span>branches: <span style="color:#f92672">[[</span>name: params<span style="color:#f92672">.</span><span style="color:#a6e22e">BRANCH</span><span style="color:#f92672">]],</span>
</span></span><span style="display:flex;"><span>                extensions: <span style="color:#f92672">[],</span>
</span></span><span style="display:flex;"><span>                userRemoteConfigs: <span style="color:#f92672">[[</span>credentialsId: params<span style="color:#f92672">.</span><span style="color:#a6e22e">GITHUB_CREDENTIAL</span><span style="color:#f92672">,</span> url: <span style="color:#e6db74">&#39;https://github.com/xxx.git&#39;</span><span style="color:#f92672">]])</span>
</span></span></code></pre></div><h2 id="jenkins是面向过程的对于任务配置多考虑使用表驱动">jenkins是面向过程的，对于任务配置，多考虑使用表驱动<a hidden class="anchor" aria-hidden="true" href="#jenkins是面向过程的对于任务配置多考虑使用表驱动">#</a></h2>
<h2 id="pipline-中访问-env-变量">Pipline 中访问 env 变量<a hidden class="anchor" aria-hidden="true" href="#pipline-中访问-env-变量">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>stage<span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    println <span style="color:#e6db74">&#34;WORKSPACE: ${env.WORKSPACE}&#34;</span>
</span></span><span style="display:flex;"><span>    echo env<span style="color:#f92672">.</span><span style="color:#a6e22e">WORKSPACE</span>
</span></span><span style="display:flex;"><span>    echo WORKSPACE
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>环境变量可以通过 Groovy 代码访问，方式为 <code>env.VARNAME</code> 或者直接使用 <code>VARNAME</code>。你也可以修改这些属性，但只能通过使用 <code>env.</code> 前缀来写入。所以：</p>
<ol>
<li>jenkins job 中有保留的 env 变量，避免疑惑这些变量要加上 <code>env.</code>。</li>
<li>env 变量即使在机器上设定了，也是可以修改的。</li>
</ol>
<h2 id="groovy中的数学计算">groovy中的数学计算<a hidden class="anchor" aria-hidden="true" href="#groovy中的数学计算">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> number <span style="color:#f92672">=</span> <span style="color:#ae81ff">243</span>  <span style="color:#75715e">// 要计算的数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> fifthRoot <span style="color:#f92672">=</span> number <span style="color:#f92672">**</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1.0</span><span style="color:#e6db74">/5)  /</span><span style="color:#f92672">/</span> <span style="color:#960050;background-color:#1e0010">计算</span><span style="color:#ae81ff">5</span><span style="color:#960050;background-color:#1e0010">次方根</span>
</span></span></code></pre></div><h2 id="两种pipline">两种pipline<a hidden class="anchor" aria-hidden="true" href="#两种pipline">#</a></h2>
<p>在Jenkins中，有两种主要类型的Pipeline：Scripted Pipeline 和 Declarative Pipeline。</p>
<ol>
<li>Scripted Pipeline【我的工作中都是这种的脚本】:</li>
</ol>
<ul>
<li>使用Groovy语法编写，允许更灵活的流程控制和自定义逻辑。</li>
<li>通过node和stage等关键字来定义流水线的执行节点和阶段。</li>
<li>可以直接编写Groovy脚本来构建流水线。</li>
</ul>
<ol start="2">
<li>Declarative Pipeline:</li>
</ol>
<ul>
<li>使用更结构化的语法，更易于阅读和维护。</li>
<li>通过pipeline、agent、stages等关键字来定义流水线的结构和执行环境。</li>
<li>提供了更丰富的语法来定义构建、部署和测试等阶段。</li>
</ul>
<h2 id="jenkins-中如何在多个-node-并行执行任务">jenkins 中如何在多个 NODE 并行执行任务<a hidden class="anchor" aria-hidden="true" href="#jenkins-中如何在多个-node-并行执行任务">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> parallel_tasks <span style="color:#f92672">=</span> <span style="color:#f92672">[:]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">GPU_TASK</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    parallel_tasks<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;GPU_TASK&#34;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        node<span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">GPU_NODE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            stage<span style="color:#f92672">(){}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">CPU_TASK</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    parallel_tasks<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;CPU_TASK&#34;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        node<span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">CPU_NODE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            stage<span style="color:#f92672">(){}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>parallel<span style="color:#f92672">(</span>parallel_tasks<span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="elvis-操作符-">Elvis 操作符 <code>?:</code><a hidden class="anchor" aria-hidden="true" href="#elvis-操作符-">#</a></h2>
<p>这两句句话有什么不同：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>Apple <span style="color:#f92672">=</span> Banana <span style="color:#f92672">?:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>Apple <span style="color:#f92672">=</span> Banana <span style="color:#f92672">?</span> Banana <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><p>两者操作符不同，<code>?:</code> 是Elvis操作符，表示如果Banana不是null或空，则将其值赋给Apple，否则Apple将会是空字符串。两者效果相同。</p>
<h2 id="关于proxy">关于proxy<a hidden class="anchor" aria-hidden="true" href="#关于proxy">#</a></h2>
<p>jenkins服务中写死的 proxy 会影响 groovy 的函数，但是在sh中的执行 你依然可以使用自己的proxy。</p>
<h2 id="使用groovy语法创建并写入python脚本">使用Groovy语法创建并写入Python脚本<a hidden class="anchor" aria-hidden="true" href="#使用groovy语法创建并写入python脚本">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#75715e">// Python脚本的内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> pythonScriptContent <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    print(&#34;Hello from Jenkins Pipeline!&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # Add more Python code here
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 将内容写入Python脚本文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>writeFile file: <span style="color:#e6db74">&#39;script.py&#39;</span><span style="color:#f92672">,</span> text: pythonScriptContent
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 执行Python脚本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>sh <span style="color:#e6db74">&#39;python script.py&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">createPythonScript</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> scriptName <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#39;echo \&#39;print(&#34;Hello, world!&#34;)\&#39; &gt; example.py&#39;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> scriptName
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>node <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Create Python Script&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> scriptName <span style="color:#f92672">=</span> createPythonScript<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Created Python script: ${scriptName}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Other Stage&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> scriptName <span style="color:#f92672">=</span> createPythonScript<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 在这里可以使用创建的Python脚本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="jenkins-文件归档">jenkins 文件归档<a hidden class="anchor" aria-hidden="true" href="#jenkins-文件归档">#</a></h2>
<p>如果在Jenkins上使用<code>archiveArtifacts</code>将生成的文件归档，即使在归档后删除了该文件，你仍然可以从Jenkins上访问该log文件，这是因为Jenkins将文件存档在特定的位置，而不是直接引用原始文件。当您使用 archiveArtifacts 步骤归档文件时，Jenkins将文件<strong>复制</strong>到其构建存档目录中，通常是Jenkins服务器上的特定位置。</p>
<p>通过页面的&quot;Artifacts&quot;或类似的部分，通常会提供一个链接或按钮，使您可以直接下载或查看归档的文件。注意，归档的文件会<strong>占用磁盘空间</strong>，因此建议在需要时删除归档的文件，以便释放磁盘空间。您可以在Jenkins的配置中调整构建存档的策略和保留期限，以满足您的需求。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>csv <span style="color:#f92672">+=</span> <span style="color:#f92672">...</span> <span style="color:#75715e">// 构建CSV文件内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>writeFile file: <span style="color:#e6db74">&#34;result.csv&#34;</span><span style="color:#f92672">,</span> text: csv
</span></span><span style="display:flex;"><span>archiveArtifacts <span style="color:#e6db74">&#39;result.csv&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>writeFile file: <span style="color:#e6db74">&#39;run_ut.sh&#39;</span><span style="color:#f92672">,</span> text: <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        #!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        set -ex
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        export CI_CACHE=/ci_cache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        export SC_HOME=/AI
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        export CI_HOME=/AI/3rdparty/AI-ci
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bash $CI_HOME/run_gcc_latest.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>withCredentials<span style="color:#f92672">([</span>gitUsernamePassword<span style="color:#f92672">(</span>credentialsId: params<span style="color:#f92672">.</span><span style="color:#a6e22e">GITHUB_CREDENTIAL</span><span style="color:#f92672">,</span> gitToolName: <span style="color:#e6db74">&#39;Default&#39;</span><span style="color:#f92672">)])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;bash scripts/ci/checkout.sh&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>sh <span style="color:#e6db74">&#34;&#34;&#34; sh ./run_ut.sh &#34;&#34;&#34;</span> <span style="color:#75715e">// 上文创建文件，这里执行
</span></span></span></code></pre></div><h2 id="访问-已经归档的-文件访问已有的-job-已有的-build">访问 已经归档的 文件，访问已有的 job 已有的 build<a hidden class="anchor" aria-hidden="true" href="#访问-已经归档的-文件访问已有的-job-已有的-build">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>copyArtifacts filter: <span style="color:#e6db74">&#39;*&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        fingerprintArtifacts: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        projectName: <span style="color:#e6db74">&#39;Triton_Release&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        selector: specific<span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">IPEX_BUILD_NUMBER</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">import</span> hudson.model.*
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jenkins.model.*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> jobName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;my-job&#34;</span> <span style="color:#75715e">// 作业名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">def</span> buildNumber <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span> <span style="color:#75715e">// 构建号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> job <span style="color:#f92672">=</span> Jenkins<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getItem</span><span style="color:#f92672">(</span>jobName<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> build <span style="color:#f92672">=</span> job<span style="color:#f92672">.</span><span style="color:#a6e22e">getBuildByNumber</span><span style="color:#f92672">(</span>buildNumber<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>build <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> artifacts <span style="color:#f92672">=</span> build<span style="color:#f92672">.</span><span style="color:#a6e22e">artifacts</span>
</span></span><span style="display:flex;"><span>    artifacts<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> artifact <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> fileName <span style="color:#f92672">=</span> artifact<span style="color:#f92672">.</span><span style="color:#a6e22e">fileName</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> relativePath <span style="color:#f92672">=</span> artifact<span style="color:#f92672">.</span><span style="color:#a6e22e">relativePath</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;File: $fileName, Path: $relativePath&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Build $buildNumber not found for job $jobName.&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="groovy中使用-each-循环-遍历一个-map在遍历中进行-if-判断">groovy中使用 <code>.each</code> 循环 遍历一个 map，在遍历中进行 if 判断<a hidden class="anchor" aria-hidden="true" href="#groovy中使用-each-循环-遍历一个-map在遍历中进行-if-判断">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> model<span style="color:#f92672">,</span> modes <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#f92672">(</span>model <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    modes<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> mode<span style="color:#f92672">,</span> types <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\t&#34;</span> <span style="color:#f92672">+</span> mode <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        types<span style="color:#f92672">.</span><span style="color:#a6e22e">each</span> <span style="color:#f92672">{</span> type <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;int8&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\t\t&#34;</span> <span style="color:#f92672">+</span> type <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; (optimized)&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\t\t&#34;</span> <span style="color:#f92672">+</span> type<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="publich-html-report">publich HTML report<a hidden class="anchor" aria-hidden="true" href="#publich-html-report">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>dir<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;result&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    copyArtifacts filter: <span style="color:#e6db74">&#39;*_perf.log&#39;</span><span style="color:#f92672">,</span> fingerprintArtifacts: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    projectName: <span style="color:#e6db74">&#39;Complex_fusion&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    selector: specific<span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">RESULT_NUMBER</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;touch conv_block.log mha.log mlp.log misc.log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>dir<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;baseline&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    copyArtifacts filter: <span style="color:#e6db74">&#39;*_perf.log&#39;</span><span style="color:#f92672">,</span> fingerprintArtifacts: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    projectName: <span style="color:#e6db74">&#39;Complex_fusion&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    selector: specific<span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">BASELINE_NUMBER</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sh <span style="color:#e6db74">&#34;touch conv_block.log mha.log mlp.log misc.log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// generate report for each model
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>workload <span style="color:#66d9ef">in</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;conv_block&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;mha&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;mlp&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;misc&#34;</span><span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> accumulate_min <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> count_min <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> accumulate_avg <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> count_avg <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> summary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;html&gt;&lt;body&gt;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    summary <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&lt;link rel=&#39;stylesheet&#39; href=&#39;perf_test.css&#39;&gt;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    summary <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&lt;table border=&#39;1&#39;&gt;\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    summary <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&lt;tr&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;cases&#39;&gt;Case&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;Result Min&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;Result Avg&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;Baseline Min&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;Baseline Avg&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;Ratio Min&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;Ratio Avg&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;/tr&gt;\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// make sure the log file exists
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sh <span style="color:#e6db74">&#34;touch result/${workload}.log baseline/${workload}.log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> res <span style="color:#f92672">=</span> parse_result<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;result/${workload}.log&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> base <span style="color:#f92672">=</span> parse_result<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;baseline/${workload}.log&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// loop each entry in the result
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// line [case,min,avg] =&gt; result {case: [min,avg]}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>entry <span style="color:#66d9ef">in</span> res<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> case_name <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> perf_min <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> perf_avg <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">[</span><span style="color:#ae81ff">1</span><span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> base_perf_min <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> base_perf_avg <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// find the base
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>base<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>case_name<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            base_perf_min <span style="color:#f92672">=</span> base<span style="color:#f92672">[</span>case_name<span style="color:#f92672">][</span><span style="color:#ae81ff">0</span><span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>            base_perf_avg <span style="color:#f92672">=</span> base<span style="color:#f92672">[</span>case_name<span style="color:#f92672">][</span><span style="color:#ae81ff">1</span><span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> ratio_min <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> css_class_min <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;na&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>base_perf_min <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> res0 <span style="color:#f92672">=</span> compare<span style="color:#f92672">(</span>perf_min<span style="color:#f92672">,</span> base_perf_min<span style="color:#f92672">,</span> ratio_min<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                css_class_min <span style="color:#f92672">=</span> res0<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                ratio_min <span style="color:#f92672">=</span> res0<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ratio_min <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">&amp;&amp;</span> ratio_min <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;0.0&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            accumulate_min <span style="color:#f92672">*=</span> ratio_min<span style="color:#f92672">.</span><span style="color:#a6e22e">toDouble</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            count_min <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> ratio_avg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> css_class_avg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;na&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>base_perf_avg <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">def</span> res1 <span style="color:#f92672">=</span> compare<span style="color:#f92672">(</span>perf_avg<span style="color:#f92672">,</span> base_perf_avg<span style="color:#f92672">,</span> ratio_avg<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            css_class_avg <span style="color:#f92672">=</span> res1<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            ratio_avg <span style="color:#f92672">=</span> res1<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ratio_avg <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">&amp;&amp;</span> ratio_avg <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;0.0&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            accumulate_avg <span style="color:#f92672">*=</span> ratio_avg<span style="color:#f92672">.</span><span style="color:#a6e22e">toDouble</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            count_avg <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        summary <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&lt;tr&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;&lt;td&gt;${case_name}&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;&lt;td&gt;${perf_min}&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;&lt;td&gt;${perf_avg}&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;&lt;td class=&#39;value&#39;&gt;${base_perf_min}&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;&lt;td class=&#39;value&#39;&gt;${base_perf_avg}&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;&lt;td class=&#39;value ${css_class_min}&#39;&gt;${ratio_min}&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;&lt;td class=&#39;value ${css_class_avg}&#39;&gt;${ratio_avg}&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;&lt;/tr&gt;\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> geomean_min
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> geomean_avg
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">if</span> <span style="color:#f92672">(</span>count_min <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>geomean_min <span style="color:#f92672">=</span> accumulate_min <span style="color:#f92672">**</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1.0</span><span style="color:#e6db74">/count_min);}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if (count_avg &gt; 0) {geomean_avg = accumulate_avg ** (1.0/</span>count_avg<span style="color:#f92672">);}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> css_geo_min <span style="color:#f92672">=</span> up_or_down<span style="color:#f92672">(</span>geomean_min<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> css_geo_avg <span style="color:#f92672">=</span> up_or_down<span style="color:#f92672">(</span>geomean_avg<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    summary <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&lt;tr&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;geomean&#39;&gt;Geomean&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column&#39;&gt;&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column ${css_geo_min}&#39;&gt;${geomean_min}&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;td class=&#39;column ${css_geo_avg}&#39;&gt;${geomean_avg}&lt;/td&gt;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;/tr&gt;\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    summary <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&lt;/table&gt;\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    summary <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&lt;/body&gt;&lt;/html&gt;\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    dir<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;summary&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 生成两个文件，html（内容）和css（格式），
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        writeFile file: <span style="color:#e6db74">&#34;perf_test.css&#34;</span><span style="color:#f92672">,</span> text: <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;.upgrade {background: lightgreen;}\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;.downgrade {background: pink;}\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;.na {background: lightgrey;}\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;.value {text-align: right;}\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;.cases {width: 500px;}\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;.geomean {border: #333333; background: rgb(172, 206, 240);}&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;.column {width: 100px;}\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        writeFile file: <span style="color:#e6db74">&#34;${workload}.html&#34;</span><span style="color:#f92672">,</span> text: summary
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>publishHTML<span style="color:#f92672">([</span>allowMissing: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            alwaysLinkToLastBuild: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            keepAll: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            reportDir: <span style="color:#e6db74">&#39;summary&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            reportFiles: <span style="color:#e6db74">&#39;conv_perf.html,mha.html,mlp.html,misc.html&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            reportName: <span style="color:#e6db74">&#39;PERF Report&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            reportTitles: <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            useWrapperFileDirectly: <span style="color:#66d9ef">true</span><span style="color:#f92672">])</span>
</span></span></code></pre></div><h2 id="jenkins-脚本一般结构">Jenkins 脚本一般结构<a hidden class="anchor" aria-hidden="true" href="#jenkins-脚本一般结构">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#f92672">import</span> org.jenkinsci.plugins.pipeline.modeldefinition.Utils
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">node</span><span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">NODE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> conda_env <span style="color:#f92672">=</span> pwd<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/conda_llm&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    withEnv<span style="color:#f92672">([</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;HTTP_PROXY=http://xxx.com:912&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;HTTPS_PROXY=http://xxx.com:912&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CMAKE_PREFIX_PATH=${conda_env}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;MALLOC_CONF=oversize_threshold:1,background_thread:true,metadata_thp:auto,dirty_decay_ms:9000000000,muzzy_decay_ms:9000000000&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_CONSTANT_CACHE=1&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_GRAPH_CONSTANT_TENSOR_CACHE_CAPACITY=cpu:-1&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_DISABLE_COMPILER_BACKEND=${params.DISABLE_COMPILER}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;VERBOSE=${param.VERBOSE}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;setup &amp; run&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            deleteDir<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            dir<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;llm&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                checkout <span style="color:#a6e22e">scmGit</span><span style="color:#f92672">(</span>branches: <span style="color:#f92672">[[</span>name: params<span style="color:#f92672">.</span><span style="color:#a6e22e">BRANCH</span><span style="color:#f92672">]],</span>
</span></span><span style="display:flex;"><span>                                extensions: <span style="color:#f92672">[],</span>
</span></span><span style="display:flex;"><span>                                userRemoteConfigs: <span style="color:#f92672">[[</span>credentialsId: params<span style="color:#f92672">.</span><span style="color:#a6e22e">GITHUB_CREDENTIAL</span><span style="color:#f92672">,</span> url: <span style="color:#e6db74">&#39;https://github.com/xxx.git&#39;</span><span style="color:#f92672">]])</span>
</span></span><span style="display:flex;"><span>                copyArtifacts filter: <span style="color:#e6db74">&#39;*&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        fingerprintArtifacts: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        projectName: <span style="color:#e6db74">&#39;YYY_Release&#39;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        selector: specific<span style="color:#f92672">(</span>env<span style="color:#f92672">.</span><span style="color:#a6e22e">IPEX_BUILD_NUMBER</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                retry<span style="color:#f92672">(</span><span style="color:#ae81ff">5</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> sh <span style="color:#e6db74">&#34;conda create --prefix ${conda_env} --file requirements.txt -c conda-forge python=3.10 -y&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                retry<span style="color:#f92672">(</span><span style="color:#ae81ff">5</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> sh <span style="color:#e6db74">&#34;conda install --prefix ${conda_env} jemalloc -y&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                dir<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;examples/cpu/inference/python/llm&#39;</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        bash ./tools/env_setup.sh 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        source ./tools/env_activate.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        source activate ${conda_env}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        python run.py
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                source activate ${conda_env}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                pip install ${params.PYTORCH_URL} --no-deps
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                pip install *.whl --no-deps
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                pip install -r requirements.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        withEnv<span style="color:#f92672">([</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;MALLOC_CONF=oversize_threshold:1,background_thread:true,metadata_thp:auto,dirty_decay_ms:9000000000,muzzy_decay_ms:9000000000&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;_CONSTANT_CACHE=1&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;GRAPH_CONSTANT_TENSOR_CACHE_CAPACITY=cpu:-1&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;_DISABLE_COMPILER_BACKEND=${params.DISABLE_COMPILER}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;VERBOSE=${param.VERBOSE}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;run llm&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                dir<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;vision&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkout <span style="color:#a6e22e">scmGit</span><span style="color:#f92672">(</span>branches: <span style="color:#f92672">[[</span>name: <span style="color:#e6db74">&#39;master&#39;</span><span style="color:#f92672">]],</span>
</span></span><span style="display:flex;"><span>                                    extensions: <span style="color:#f92672">[],</span>
</span></span><span style="display:flex;"><span>                                    userRemoteConfigs: <span style="color:#f92672">[[</span>credentialsId: params<span style="color:#f92672">.</span><span style="color:#a6e22e">GITHUB_CREDENTIAL</span><span style="color:#f92672">,</span> url: <span style="color:#e6db74">&#39;https://github.com/xxx.git&#39;</span><span style="color:#f92672">]])</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        source activate ${conda_env}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>dt <span style="color:#66d9ef">in</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;int8_ipex&#34;</span><span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            source activate ${conda_env}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            bash run_test.sh all ${dt} ${params.mode} int8_ipex
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        cp logs/summary.log ./vision.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                    archiveArtifacts <span style="color:#e6db74">&#39;vision.log&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="坑shell的带特殊符号的环境变量">坑：shell的带特殊符号的环境变量<a hidden class="anchor" aria-hidden="true" href="#坑shell的带特殊符号的环境变量">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>withEnv<span style="color:#f92672">([</span><span style="color:#e6db74">&#34;CACHE_CAPACITY=cpu:10240;gpu:20480&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;CACHE_CAPACITY_2=&#39;cpu:10240;gpu:20480&#39;&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;CACHE_CAPACITY_3=\&#34;cpu:10240;gpu:20480\&#34;&#34;</span><span style="color:#f92672">]){</span>
</span></span><span style="display:flex;"><span>    echo env<span style="color:#f92672">.</span><span style="color:#a6e22e">CACHE_CAPACITY</span><span style="color:#f92672">;</span>       <span style="color:#75715e">// cpu:10240;gpu:20480     v
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    echo env<span style="color:#f92672">.</span><span style="color:#a6e22e">CACHE_CAPACITY_2</span><span style="color:#f92672">;</span>     <span style="color:#75715e">// &#39;cpu:10240;gpu:20480&#39;   x
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    echo env<span style="color:#f92672">.</span><span style="color:#a6e22e">CACHE_CAPACITY_3</span><span style="color:#f92672">;</span>     <span style="color:#75715e">// &#34;cpu:10240;gpu:20480&#34;   x
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sh<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        export CACHE_CAPACITY_4=&#34;cpu:10240;gpu:20480&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo \${CACHE_CAPACITY}    ## cpu:10240;gpu:20480     v
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo \${CACHE_CAPACITY_2}  ## &#39;cpu:10240;gpu:20480&#39;   x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo \${CACHE_CAPACITY_3}  ## &#34;cpu:10240;gpu:20480&#34;   x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo \${CACHE_CAPACITY_4}  ## cpu:10240;gpu:20480     v
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>withEnv</code> 中变量的值，不加双引号！</p>
<h2 id="坑jenkins-中的用户访问不到-gpu">坑：jenkins 中的用户访问不到 GPU<a hidden class="anchor" aria-hidden="true" href="#坑jenkins-中的用户访问不到-gpu">#</a></h2>
<p>在机器上给用户访问权限后，直接在机器上是可以访问，但是jenkins的pipline中相同的用户还是不能访问。</p>
<p>答：jenkins系统上需要重启机器，后就可以了
jenkins上的agent其实是一直运行 的，可以理解成jenkins系统中这个shell从来没有变过，重启才生效</p>
<h2 id="坑-vs-">坑：&rsquo;&rsquo; vs &quot;&quot;<a hidden class="anchor" aria-hidden="true" href="#坑-vs-">#</a></h2>
<p>在Groovy中，&rsquo;&rsquo; 和 &quot;&quot; 都表示空字符串，它们在功能上是等价的。因此，在<code>my_list.add('')</code>和<code>my_list.add(&quot;&quot;)</code>这两行代码中，它们的作用是相同的，都是向<code>my_list</code>中添加一个空字符串。 Groovy允许使用单引号或双引号来表示字符串，这两种表示方法在大多数情况下是可以互换使用的。</p>
<h2 id="坑withenv的参数是一个list其内容可以是空但必须要给一个list-对象">坑：withEnv()的参数是一个List，其内容可以是空但必须要给一个List 对象<a hidden class="anchor" aria-hidden="true" href="#坑withenv的参数是一个list其内容可以是空但必须要给一个list-对象">#</a></h2>
<p>jenkins 报错：hudson.remoting.ProxyException: java.lang.NullPointerException: Cannot invoke &ldquo;java.util.List.iterator()&rdquo; because &ldquo;overrides&rdquo; is null</p>
<h2 id="坑withenv">坑：withEnv([])<a hidden class="anchor" aria-hidden="true" href="#坑withenv">#</a></h2>
<p>jenkins 报错：process apparently never started in &hellip;
答：检查withEnv中的环境变量是否符合预期。注意要在sh中检查环境变量的值，最好将所有的 env 输出到文件并且archive起来，便于检查</p>
<h2 id="坑shell-的-pid">坑：shell 的 pid<a hidden class="anchor" aria-hidden="true" href="#坑shell-的-pid">#</a></h2>
<p>不同的 sh &quot;&quot;&quot; &ldquo;&rdquo;&quot;, 之间的 <strong>pid 不相同</strong>，不共用环境，包括conda环境。<strong>如果要公用，则需要通过 withEnv添加</strong></p>
<h2 id="坑sh--vd-sh-">坑：sh &quot;&quot;&quot; vd sh &rsquo;''<a hidden class="anchor" aria-hidden="true" href="#坑sh--vd-sh-">#</a></h2>
<p>sh &quot;&quot;&quot; 中的变量要是 jenkins 脚本的变量， <strong>先获取变量值，替换后，再执行shell</strong>
sh &rsquo;&rsquo;&rsquo; 中变量是 shell 脚本自身的变量， <strong>直接执行shell</strong></p>
<h2 id="坑案例分析">坑：案例分析<a hidden class="anchor" aria-hidden="true" href="#坑案例分析">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>sh <span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    source ~/miniconda3/etc/profile.d/conda.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    if [ &#34;\$(conda info --env | grep ${CONDA_ENV} | wc -l )&#34; == &#34;0&#34; ];then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        conda create -n ${CONDA_ENV} python=3.10 openpyxl csv -y
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    conda activate ${CONDA_ENV}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    bash ${WORKSPACE}/tools/bdnn/jenkins_utils/collect_result.sh ${cfg[2]}_perf.log perf.log
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    python ${WORKSPACE}/tools/bdnn/jenkins_utils/to_excel.py perf.log ${cfg[2]}_perf.xlsx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>if 条件中 <code>&quot;\$(conda info --env...&quot;</code>  的第一个<code>$</code>, 需要转义，告诉 jenkins 不要替换 <code>$</code>后的内容，其他jenkins变量替换之后，这个<code>$</code>作为shell脚本的内容执行。</p>
<h2 id="坑访问函数参数--sh-vs--sh-两者区别">坑：访问函数参数  sh&quot;&quot;&quot; vs  sh&rsquo;&rsquo;&rsquo; 两者区别<a hidden class="anchor" aria-hidden="true" href="#坑访问函数参数--sh-vs--sh-两者区别">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">Select_Model</span><span style="color:#f92672">(</span>direction<span style="color:#f92672">,</span> dtype<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;======inside of Select()=====&gt;&#34;</span> <span style="color:#f92672">+</span> direction<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    sh<span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo &#34;------ &gt; $direction&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>上面函数中变量<code>direction</code> 为什么在sh中访问不到，echo得到是空？</p>
<p>改为一下就可以：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">Select_Model</span><span style="color:#f92672">(</span>direction<span style="color:#f92672">,</span> dtype<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;======inside of Select()=====&gt;&#34;</span> <span style="color:#f92672">+</span> direction<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    sh<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo &#34;------ &gt; ${direction}&#34;  // allows for string interpolation, 先获取direction值，后执行shell
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>因为 <code>sh&quot;&quot;&quot;</code> 里通过 <code>$ </code>来获取groovy的变量，如上例，<code>$direction</code> 获取函数参数的值替换后，执行shell。而<code>sh'''</code> 里边不能获取groovy变量的值，只能通过 <code>withEnv</code> 的方式间接获取，所以如果要使用 <code>sh'''</code> 那么应改为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">Select_Model</span><span style="color:#f92672">(</span>direction<span style="color:#f92672">,</span> dtype<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    withEnv<span style="color:#f92672">([</span><span style="color:#e6db74">&#34;Direction=${direction}&#34;</span><span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;======inside of Select()=====&gt;&#34;</span> <span style="color:#f92672">+</span> direction<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        sh<span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo &#34;------ &gt; ${Direction}&#34;  // 不会string interpolation, 原样输出，后执行shell，此时Direction已经是个环境变量了
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="坑dir-">坑：dir ()<a hidden class="anchor" aria-hidden="true" href="#坑dir-">#</a></h2>
<p>在Jenkins中，<code>dir('${MY}')</code>[错误] 和 <code>dir(&quot;${MY}&quot;)</code>[正确] 之间的主要区别在于引号的类型。单引号和双引号在Groovy中有不同的用途：</p>
<p><code>dir('${MY}')</code> 使用了单引号，这意味着${MY}不会被解释为变量，而会被视为普通的字符串。这将导致Jenkins尝试切换到一个名为 <code>${MY}</code> 的目录，而不是切换到环境变量 MY 的值所表示的目录。因此，这种写法通常不会达到预期的效果，除非您确实有一个名为${MY}的目录。</p>
<p><code>dir(&quot;${MY}&quot;)</code> 使用了双引号，这意味着${MY}会被解释为变量，并用其值替换。如果环境变量 MY 的值是一个有效的目录路径，那么Jenkins会尝试切换到这个目录。</p>
<p>所以，一般情况下，如果您希望在dir命令中引用一个环境变量的值作为目录路径，应该使用双引号，如<code>dir(&quot;${MY}&quot;)</code>。这将使Jenkins正确地解释${MY}作为变量，并使用它的值作为目录路径</p>
<p>所以，Jenkins中没有特殊理由，都是用双引号 &quot;&quot;&quot; 。</p>
<h2 id="坑方法不可用">坑：方法不可用<a hidden class="anchor" aria-hidden="true" href="#坑方法不可用">#</a></h2>
<p>默认情况下，许多敏感方法是被禁止的，以确保Jenkins的安全性。当您在Jenkins中执行Groovy脚本时，可能会遇到安全限制，例如 &ldquo;Scripts not permitted to use method&rdquo; 的错误消息。这是由于Jenkins的脚本安全性设置所引起的。</p>
<p>Administer Jenkins 权限的用户可以配置 Jenkins 的脚本安全性设置，以允许或拒绝特定方法的使用。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://ashburnLee.github.io/blog-2-hugo/tags/jenkins/">Jenkins</a></li>
      <li><a href="https://ashburnLee.github.io/blog-2-hugo/tags/cicd/">CICD</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://ashburnLee.github.io/blog-2-hugo/">Junhui&#39;s Journal 2</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
