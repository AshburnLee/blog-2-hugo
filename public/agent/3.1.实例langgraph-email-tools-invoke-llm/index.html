<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>3.1.实例langgraph Email Tools Invoke Llm | Junhui&#39;s Journal 2</title>
<meta name="keywords" content="Agent, LangGraph">
<meta name="description" content="实例的完整过程在这里
该实例的作用和功能是：
重点：

State 类在定义时要足够全面，以便跟踪所有重要信息。
message 对象是 用户定义的 Prompt 内容。
一个 Node 执行结束之前要更新 message。即 append 内容到之前的message。
每一个 Node 的返回值应该是 states updates。
LLM 的作用是在每一个 Node 中，model.invoke(prompt) 来让 model 做动作。
所有组件定义好之后，通过创建 StateGraph 将所有组件添加到这个数据结构中，组装成图。记得将 END 节点加入 StateGraph 中。
使用可观测性工具来跟踪和监控代理。比如 LangFuse。Langfuse的API Key本身是免费申请的，使用Hobby计划，不需要绑定信用卡，包含50,000个单位/月的免费额度，支持两名用户，数据保留30天，以及社区支持。

setup
name: aiagent
dependencies:
  - python=3.10.12
  - pip
  - pip:
    - langgraph
    - langchain_ollama
conda env create --file environment.yml
具体步骤：
import os
from typing import TypedDict, List, Dict, Any, Optional
from langgraph.graph import StateGraph, START, END
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage
定义 State：">
<meta name="author" content="">
<link rel="canonical" href="https://ashburnLee.github.io/blog-2-hugo/agent/3.1.%E5%AE%9E%E4%BE%8Blanggraph-email-tools-invoke-llm/">
<link crossorigin="anonymous" href="/blog-2-hugo/assets/css/stylesheet.bdaf5941cb3c05e36e857d9e2953ba0c4485ba7bc2da15db169d66a77cbc7a87.css" integrity="sha256-va9ZQcs8BeNuhX2eKVO6DESFunvC2hXbFp1mp3y8eoc=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://ashburnLee.github.io/blog-2-hugo/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ashburnLee.github.io/blog-2-hugo/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://ashburnLee.github.io/blog-2-hugo/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://ashburnLee.github.io/blog-2-hugo/apple-touch-icon.png">
<link rel="mask-icon" href="https://ashburnLee.github.io/blog-2-hugo/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://ashburnLee.github.io/blog-2-hugo/agent/3.1.%E5%AE%9E%E4%BE%8Blanggraph-email-tools-invoke-llm/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" id="MathJax-script" async></script>


<meta property="og:url" content="https://ashburnLee.github.io/blog-2-hugo/agent/3.1.%E5%AE%9E%E4%BE%8Blanggraph-email-tools-invoke-llm/">
  <meta property="og:site_name" content="Junhui&#39;s Journal 2">
  <meta property="og:title" content="3.1.实例langgraph Email Tools Invoke Llm">
  <meta property="og:description" content="实例的完整过程在这里
该实例的作用和功能是：
重点： State 类在定义时要足够全面，以便跟踪所有重要信息。 message 对象是 用户定义的 Prompt 内容。 一个 Node 执行结束之前要更新 message。即 append 内容到之前的message。 每一个 Node 的返回值应该是 states updates。 LLM 的作用是在每一个 Node 中，model.invoke(prompt) 来让 model 做动作。 所有组件定义好之后，通过创建 StateGraph 将所有组件添加到这个数据结构中，组装成图。记得将 END 节点加入 StateGraph 中。 使用可观测性工具来跟踪和监控代理。比如 LangFuse。Langfuse的API Key本身是免费申请的，使用Hobby计划，不需要绑定信用卡，包含50,000个单位/月的免费额度，支持两名用户，数据保留30天，以及社区支持。 setup name: aiagent dependencies: - python=3.10.12 - pip - pip: - langgraph - langchain_ollama conda env create --file environment.yml 具体步骤： import os from typing import TypedDict, List, Dict, Any, Optional from langgraph.graph import StateGraph, START, END from langchain_openai import ChatOpenAI from langchain_core.messages import HumanMessage 定义 State：">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="agent">
    <meta property="article:published_time" content="2025-08-31T12:13:30+08:00">
    <meta property="article:modified_time" content="2025-08-31T12:13:30+08:00">
    <meta property="article:tag" content="Agent">
    <meta property="article:tag" content="LangGraph">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="3.1.实例langgraph Email Tools Invoke Llm">
<meta name="twitter:description" content="实例的完整过程在这里
该实例的作用和功能是：
重点：

State 类在定义时要足够全面，以便跟踪所有重要信息。
message 对象是 用户定义的 Prompt 内容。
一个 Node 执行结束之前要更新 message。即 append 内容到之前的message。
每一个 Node 的返回值应该是 states updates。
LLM 的作用是在每一个 Node 中，model.invoke(prompt) 来让 model 做动作。
所有组件定义好之后，通过创建 StateGraph 将所有组件添加到这个数据结构中，组装成图。记得将 END 节点加入 StateGraph 中。
使用可观测性工具来跟踪和监控代理。比如 LangFuse。Langfuse的API Key本身是免费申请的，使用Hobby计划，不需要绑定信用卡，包含50,000个单位/月的免费额度，支持两名用户，数据保留30天，以及社区支持。

setup
name: aiagent
dependencies:
  - python=3.10.12
  - pip
  - pip:
    - langgraph
    - langchain_ollama
conda env create --file environment.yml
具体步骤：
import os
from typing import TypedDict, List, Dict, Any, Optional
from langgraph.graph import StateGraph, START, END
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage
定义 State：">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Agent",
      "item": "https://ashburnLee.github.io/blog-2-hugo/agent/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "3.1.实例langgraph Email Tools Invoke Llm",
      "item": "https://ashburnLee.github.io/blog-2-hugo/agent/3.1.%E5%AE%9E%E4%BE%8Blanggraph-email-tools-invoke-llm/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "3.1.实例langgraph Email Tools Invoke Llm",
  "name": "3.1.实例langgraph Email Tools Invoke Llm",
  "description": "实例的完整过程在这里\n该实例的作用和功能是：\n重点： State 类在定义时要足够全面，以便跟踪所有重要信息。 message 对象是 用户定义的 Prompt 内容。 一个 Node 执行结束之前要更新 message。即 append 内容到之前的message。 每一个 Node 的返回值应该是 states updates。 LLM 的作用是在每一个 Node 中，model.invoke(prompt) 来让 model 做动作。 所有组件定义好之后，通过创建 StateGraph 将所有组件添加到这个数据结构中，组装成图。记得将 END 节点加入 StateGraph 中。 使用可观测性工具来跟踪和监控代理。比如 LangFuse。Langfuse的API Key本身是免费申请的，使用Hobby计划，不需要绑定信用卡，包含50,000个单位/月的免费额度，支持两名用户，数据保留30天，以及社区支持。 setup name: aiagent dependencies: - python=3.10.12 - pip - pip: - langgraph - langchain_ollama conda env create --file environment.yml 具体步骤： import os from typing import TypedDict, List, Dict, Any, Optional from langgraph.graph import StateGraph, START, END from langchain_openai import ChatOpenAI from langchain_core.messages import HumanMessage 定义 State：\n",
  "keywords": [
    "Agent", "LangGraph"
  ],
  "articleBody": "实例的完整过程在这里\n该实例的作用和功能是：\n重点： State 类在定义时要足够全面，以便跟踪所有重要信息。 message 对象是 用户定义的 Prompt 内容。 一个 Node 执行结束之前要更新 message。即 append 内容到之前的message。 每一个 Node 的返回值应该是 states updates。 LLM 的作用是在每一个 Node 中，model.invoke(prompt) 来让 model 做动作。 所有组件定义好之后，通过创建 StateGraph 将所有组件添加到这个数据结构中，组装成图。记得将 END 节点加入 StateGraph 中。 使用可观测性工具来跟踪和监控代理。比如 LangFuse。Langfuse的API Key本身是免费申请的，使用Hobby计划，不需要绑定信用卡，包含50,000个单位/月的免费额度，支持两名用户，数据保留30天，以及社区支持。 setup name: aiagent dependencies: - python=3.10.12 - pip - pip: - langgraph - langchain_ollama conda env create --file environment.yml 具体步骤： import os from typing import TypedDict, List, Dict, Any, Optional from langgraph.graph import StateGraph, START, END from langchain_openai import ChatOpenAI from langchain_core.messages import HumanMessage 定义 State：\nclass EmailState(TypedDict): # The email being processed email: Dict[str, Any] # Contains subject, sender, body, etc. # Category of the email (inquiry, complaint, etc.) email_category: Optional[str] # Reason why the email was marked as spam spam_reason: Optional[str] # Analysis and decisions is_spam: Optional[bool] # Response generation email_draft: Optional[str] # Processing metadata messages: List[Dict[str, Any]] # Track conversation with LLM for analysis 定义 Nodes：\n# Initialize our LLM model = ChatOpenAI(temperature=0) def read_email(state: EmailState): \"\"\"Alfred reads and logs the incoming email\"\"\" email = state[\"email\"] # Here we might do some initial preprocessing print(f\"Alfred is processing an email from {email['sender']} with subject: {email['subject']}\") # No state changes needed here return {} def classify_email(state: EmailState): \"\"\"Alfred uses an LLM to determine if the email is spam or legitimate\"\"\" email = state[\"email\"] # Prepare our prompt for the LLM prompt = f\"\"\" As Alfred the butler, analyze this email and determine if it is spam or legitimate. Email: From: {email['sender']} Subject: {email['subject']} Body: {email['body']} First, determine if this email is spam. If it is spam, explain why. If it is legitimate, categorize it (inquiry, complaint, thank you, etc.). \"\"\" # Call the LLM messages = [HumanMessage(content=prompt)] response = model.invoke(messages) # Simple logic to parse the response (in a real app, you'd want more robust parsing) response_text = response.content.lower() is_spam = \"spam\" in response_text and \"not spam\" not in response_text # Extract a reason if it's spam spam_reason = None if is_spam and \"reason:\" in response_text: spam_reason = response_text.split(\"reason:\")[1].strip() # Determine category if legitimate email_category = None if not is_spam: categories = [\"inquiry\", \"complaint\", \"thank you\", \"request\", \"information\"] for category in categories: if category in response_text: email_category = category break # Update messages for tracking new_messages = state.get(\"messages\", []) + [ {\"role\": \"user\", \"content\": prompt}, {\"role\": \"assistant\", \"content\": response.content} ] # Return state updates return { \"is_spam\": is_spam, \"spam_reason\": spam_reason, \"email_category\": email_category, \"messages\": new_messages } def handle_spam(state: EmailState): \"\"\"Alfred discards spam email with a note\"\"\" print(f\"Alfred has marked the email as spam. Reason: {state['spam_reason']}\") print(\"The email has been moved to the spam folder.\") # We're done processing this email return {} def draft_response(state: EmailState): \"\"\"Alfred drafts a preliminary response for legitimate emails\"\"\" email = state[\"email\"] category = state[\"email_category\"] or \"general\" # Prepare our prompt for the LLM prompt = f\"\"\" As Alfred the butler, draft a polite preliminary response to this email. Email: From: {email['sender']} Subject: {email['subject']} Body: {email['body']} This email has been categorized as: {category} Draft a brief, professional response that Mr. Hugg can review and personalize before sending. \"\"\" # Call the LLM messages = [HumanMessage(content=prompt)] response = model.invoke(messages) # Update messages for tracking new_messages = state.get(\"messages\", []) + [ {\"role\": \"user\", \"content\": prompt}, {\"role\": \"assistant\", \"content\": response.content} ] # Return state updates return { \"email_draft\": response.content, \"messages\": new_messages } def notify_mr_hugg(state: EmailState): \"\"\"Alfred notifies Mr. Hugg about the email and presents the draft response\"\"\" email = state[\"email\"] print(\"\\n\" + \"=\"*50) print(f\"Sir, you've received an email from {email['sender']}.\") print(f\"Subject: {email['subject']}\") print(f\"Category: {state['email_category']}\") print(\"\\nI've prepared a draft response for your review:\") print(\"-\"*50) print(state[\"email_draft\"]) print(\"=\"*50 + \"\\n\") # We're done processing this email return {} 定义 Routing Logic来判断分类后的路径\ndef route_email(state: EmailState) -\u003e str: \"\"\"Determine the next step based on spam classification\"\"\" if state[\"is_spam\"]: return \"spam\" else: return \"legitimate\" 创建 StateGraph 并将所有内容链接起来：\n# Create the graph email_graph = StateGraph(EmailState) # Add nodes email_graph.add_node(\"read_email\", read_email) email_graph.add_node(\"classify_email\", classify_email) email_graph.add_node(\"handle_spam\", handle_spam) email_graph.add_node(\"draft_response\", draft_response) email_graph.add_node(\"notify_mr_hugg\", notify_mr_hugg) # Start the edges email_graph.add_edge(START, \"read_email\") # Add edges - defining the flow email_graph.add_edge(\"read_email\", \"classify_email\") # Add conditional branching from classify_email email_graph.add_conditional_edges( \"classify_email\", route_email, { \"spam\": \"handle_spam\", \"legitimate\": \"draft_response\" } ) # Add the final edges email_graph.add_edge(\"handle_spam\", END) email_graph.add_edge(\"draft_response\", \"notify_mr_hugg\") email_graph.add_edge(\"notify_mr_hugg\", END) # Compile the graph compiled_graph = email_graph.compile() 执行 Application：\n# Example legitimate email legitimate_email = { \"sender\": \"john.smith@example.com\", \"subject\": \"Question about your services\", \"body\": \"Dear Mr. Hugg, I was referred to you by a colleague and I'm interested in learning more about your consulting services. Could we schedule a call next week? Best regards, John Smith\" } # Example spam email spam_email = { \"sender\": \"winner@lottery-intl.com\", \"subject\": \"YOU HAVE WON $5,000,000!!!\", \"body\": \"CONGRATULATIONS! You have been selected as the winner of our international lottery! To claim your $5,000,000 prize, please send us your bank details and a processing fee of $100.\" } # Process the legitimate email print(\"\\nProcessing legitimate email...\") legitimate_result = compiled_graph.invoke({ \"email\": legitimate_email, \"is_spam\": None, \"spam_reason\": None, \"email_category\": None, \"email_draft\": None, \"messages\": [] }) # Process the spam email print(\"\\nProcessing spam email...\") spam_result = compiled_graph.invoke({ \"email\": spam_email, \"is_spam\": None, \"spam_reason\": None, \"email_category\": None, \"email_draft\": None, \"messages\": [] }) 可视化图\ncompiled_graph.get_graph().draw_mermaid_png() 这展示了如何通过 LangGraph 利用 LLMs，提现了 LangGraph 的 orchestrate 能力，即编排复杂工作流程的能力。\n问题 model = ChatOpenAI(api_key=\"your OpenAI_API_Key\", temperature=0) 你需要有 openai 的 API key。\n使用本地的 Ollama 部署的 LLM import os # 11434 是ollama 服务的端口 os.environ[\"http_proxy\"] = \"http://127.0.0.1:11434\" os.environ[\"https_proxy\"] = \"http://127.0.0.1:11434\" # 指定你本地 Ollama 模型的名称和本地API地址 infer_server_url = \"http://localhost:11434/v1\" model_name = \"deepseek-r1:1.5b\" model = ChatOllama( model=model_name, openai_api_base=infer_server_url, openai_api_key=\"none\", # Ollama 不需要真实API Key，设置为 none temperature=0, ) 执行脚本之前，需要确保Ollama server已经开启。\n确实使用了 local LLM，但是输出似乎不符合预期？ KAQ: 只有命令行的 Linux 不能显示 Graph 结构，如何查看？ 输出 mermaid 源码，然后拷贝到在线的 mermaid 编辑器中查看。\nKAQ: 充分使用了 Jetson 的 CPU，GPU 没有使用上？ ",
  "wordCount" : "914",
  "inLanguage": "en",
  "datePublished": "2025-08-31T12:13:30+08:00",
  "dateModified": "2025-08-31T12:13:30+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ashburnLee.github.io/blog-2-hugo/agent/3.1.%E5%AE%9E%E4%BE%8Blanggraph-email-tools-invoke-llm/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Junhui's Journal 2",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ashburnLee.github.io/blog-2-hugo/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ashburnLee.github.io/blog-2-hugo/" accesskey="h" title="Junhui&#39;s Journal 2 (Alt + H)">Junhui&#39;s Journal 2</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ashburnLee.github.io/blog-2-hugo/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://ashburnLee.github.io/blog-2-hugo/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://ashburnLee.github.io/blog-2-hugo/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      3.1.实例langgraph Email Tools Invoke Llm
    </h1>
    <div class="post-meta"><span title='2025-08-31 12:13:30 +0800 CST'>August 31, 2025</span>

</div>
  </header> 
  <div class="post-content"><p>实例的完整过程在<a href="https://huggingface.co/learn/agents-course/unit2/langgraph/first_graph#step-3-define-our-routing-logic">这里</a></p>
<p>该实例的作用和功能是：</p>
<h1 id="重点">重点：<a hidden class="anchor" aria-hidden="true" href="#重点">#</a></h1>
<ol>
<li>State 类在定义时要足够全面，以便跟踪所有重要信息。</li>
<li><code>message</code> 对象是 用户定义的 Prompt 内容。</li>
<li>一个 Node 执行结束之前要更新 <code>message</code>。即 append 内容到之前的<code>message</code>。</li>
<li>每一个 Node 的返回值应该是 states updates。</li>
<li>LLM 的作用是在每一个 Node 中，<code>model.invoke(prompt)</code> 来让 model 做动作。</li>
<li>所有组件定义好之后，通过创建 StateGraph 将所有组件添加到这个数据结构中，组装成图。记得将 END 节点加入 StateGraph 中。</li>
<li>使用可观测性工具来跟踪和监控代理。比如 <code>LangFuse</code>。Langfuse的API Key本身是免费申请的，使用Hobby计划，不需要绑定信用卡，包含50,000个单位/月的免费额度，支持两名用户，数据保留30天，以及社区支持。</li>
</ol>
<h1 id="setup">setup<a hidden class="anchor" aria-hidden="true" href="#setup">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">aiagent</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">dependencies</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">python=3.10.12</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">pip</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">pip</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">langgraph</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">langchain_ollama</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda env create --file environment.yml
</span></span></code></pre></div><h1 id="具体步骤">具体步骤：<a hidden class="anchor" aria-hidden="true" href="#具体步骤">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> TypedDict, List, Dict, Any, Optional
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> langgraph.graph <span style="color:#f92672">import</span> StateGraph, START, END
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> langchain_openai <span style="color:#f92672">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> langchain_core.messages <span style="color:#f92672">import</span> HumanMessage
</span></span></code></pre></div><p>定义 State：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailState</span>(TypedDict):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The email being processed</span>
</span></span><span style="display:flex;"><span>    email: Dict[str, Any]  <span style="color:#75715e"># Contains subject, sender, body, etc.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Category of the email (inquiry, complaint, etc.)</span>
</span></span><span style="display:flex;"><span>    email_category: Optional[str]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reason why the email was marked as spam</span>
</span></span><span style="display:flex;"><span>    spam_reason: Optional[str]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Analysis and decisions</span>
</span></span><span style="display:flex;"><span>    is_spam: Optional[bool]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Response generation</span>
</span></span><span style="display:flex;"><span>    email_draft: Optional[str]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Processing metadata</span>
</span></span><span style="display:flex;"><span>    messages: List[Dict[str, Any]]  <span style="color:#75715e"># Track conversation with LLM for analysis</span>
</span></span></code></pre></div><p>定义 Nodes：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize our LLM</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> ChatOpenAI(temperature<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_email</span>(state: EmailState):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Alfred reads and logs the incoming email&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    email <span style="color:#f92672">=</span> state[<span style="color:#e6db74">&#34;email&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Here we might do some initial preprocessing</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Alfred is processing an email from </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;sender&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> with subject: </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;subject&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># No state changes needed here</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">classify_email</span>(state: EmailState):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Alfred uses an LLM to determine if the email is spam or legitimate&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    email <span style="color:#f92672">=</span> state[<span style="color:#e6db74">&#34;email&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prepare our prompt for the LLM</span>
</span></span><span style="display:flex;"><span>    prompt <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    As Alfred the butler, analyze this email and determine if it is spam or legitimate.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Email:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    From: </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;sender&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Subject: </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;subject&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Body: </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;body&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    First, determine if this email is spam. If it is spam, explain why.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    If it is legitimate, categorize it (inquiry, complaint, thank you, etc.).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Call the LLM</span>
</span></span><span style="display:flex;"><span>    messages <span style="color:#f92672">=</span> [HumanMessage(content<span style="color:#f92672">=</span>prompt)]
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>invoke(messages)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Simple logic to parse the response (in a real app, you&#39;d want more robust parsing)</span>
</span></span><span style="display:flex;"><span>    response_text <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>content<span style="color:#f92672">.</span>lower()
</span></span><span style="display:flex;"><span>    is_spam <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;spam&#34;</span> <span style="color:#f92672">in</span> response_text <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;not spam&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> response_text
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract a reason if it&#39;s spam</span>
</span></span><span style="display:flex;"><span>    spam_reason <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> is_spam <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;reason:&#34;</span> <span style="color:#f92672">in</span> response_text:
</span></span><span style="display:flex;"><span>        spam_reason <span style="color:#f92672">=</span> response_text<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;reason:&#34;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Determine category if legitimate</span>
</span></span><span style="display:flex;"><span>    email_category <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_spam:
</span></span><span style="display:flex;"><span>        categories <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;inquiry&#34;</span>, <span style="color:#e6db74">&#34;complaint&#34;</span>, <span style="color:#e6db74">&#34;thank you&#34;</span>, <span style="color:#e6db74">&#34;request&#34;</span>, <span style="color:#e6db74">&#34;information&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> category <span style="color:#f92672">in</span> categories:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> category <span style="color:#f92672">in</span> response_text:
</span></span><span style="display:flex;"><span>                email_category <span style="color:#f92672">=</span> category
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Update messages for tracking</span>
</span></span><span style="display:flex;"><span>    new_messages <span style="color:#f92672">=</span> state<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;messages&#34;</span>, []) <span style="color:#f92672">+</span> [
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#34;role&#34;</span>: <span style="color:#e6db74">&#34;user&#34;</span>, <span style="color:#e6db74">&#34;content&#34;</span>: prompt},
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#34;role&#34;</span>: <span style="color:#e6db74">&#34;assistant&#34;</span>, <span style="color:#e6db74">&#34;content&#34;</span>: response<span style="color:#f92672">.</span>content}
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Return state updates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;is_spam&#34;</span>: is_spam,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;spam_reason&#34;</span>: spam_reason,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email_category&#34;</span>: email_category,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;messages&#34;</span>: new_messages
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_spam</span>(state: EmailState):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Alfred discards spam email with a note&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Alfred has marked the email as spam. Reason: </span><span style="color:#e6db74">{</span>state[<span style="color:#e6db74">&#39;spam_reason&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;The email has been moved to the spam folder.&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># We&#39;re done processing this email</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draft_response</span>(state: EmailState):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Alfred drafts a preliminary response for legitimate emails&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    email <span style="color:#f92672">=</span> state[<span style="color:#e6db74">&#34;email&#34;</span>]
</span></span><span style="display:flex;"><span>    category <span style="color:#f92672">=</span> state[<span style="color:#e6db74">&#34;email_category&#34;</span>] <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;general&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Prepare our prompt for the LLM</span>
</span></span><span style="display:flex;"><span>    prompt <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    As Alfred the butler, draft a polite preliminary response to this email.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Email:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    From: </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;sender&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Subject: </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;subject&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Body: </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;body&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This email has been categorized as: </span><span style="color:#e6db74">{</span>category<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Draft a brief, professional response that Mr. Hugg can review and personalize before sending.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Call the LLM</span>
</span></span><span style="display:flex;"><span>    messages <span style="color:#f92672">=</span> [HumanMessage(content<span style="color:#f92672">=</span>prompt)]
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>invoke(messages)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Update messages for tracking</span>
</span></span><span style="display:flex;"><span>    new_messages <span style="color:#f92672">=</span> state<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;messages&#34;</span>, []) <span style="color:#f92672">+</span> [
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#34;role&#34;</span>: <span style="color:#e6db74">&#34;user&#34;</span>, <span style="color:#e6db74">&#34;content&#34;</span>: prompt},
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#34;role&#34;</span>: <span style="color:#e6db74">&#34;assistant&#34;</span>, <span style="color:#e6db74">&#34;content&#34;</span>: response<span style="color:#f92672">.</span>content}
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Return state updates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email_draft&#34;</span>: response<span style="color:#f92672">.</span>content,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;messages&#34;</span>: new_messages
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">notify_mr_hugg</span>(state: EmailState):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Alfred notifies Mr. Hugg about the email and presents the draft response&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    email <span style="color:#f92672">=</span> state[<span style="color:#e6db74">&#34;email&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;=&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Sir, you&#39;ve received an email from </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;sender&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Subject: </span><span style="color:#e6db74">{</span>email[<span style="color:#e6db74">&#39;subject&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Category: </span><span style="color:#e6db74">{</span>state[<span style="color:#e6db74">&#39;email_category&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">I&#39;ve prepared a draft response for your review:&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>    print(state[<span style="color:#e6db74">&#34;email_draft&#34;</span>])
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;=&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># We&#39;re done processing this email</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {}
</span></span></code></pre></div><p>定义 Routing Logic来判断分类后的路径</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">route_email</span>(state: EmailState) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Determine the next step based on spam classification&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> state[<span style="color:#e6db74">&#34;is_spam&#34;</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;spam&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;legitimate&#34;</span>
</span></span></code></pre></div><p>创建 StateGraph 并将所有内容链接起来：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e"># Create the graph</span>
</span></span><span style="display:flex;"><span>email_graph <span style="color:#f92672">=</span> StateGraph(EmailState)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add nodes</span>
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_node(<span style="color:#e6db74">&#34;read_email&#34;</span>, read_email)
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_node(<span style="color:#e6db74">&#34;classify_email&#34;</span>, classify_email)
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_node(<span style="color:#e6db74">&#34;handle_spam&#34;</span>, handle_spam)
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_node(<span style="color:#e6db74">&#34;draft_response&#34;</span>, draft_response)
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_node(<span style="color:#e6db74">&#34;notify_mr_hugg&#34;</span>, notify_mr_hugg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start the edges</span>
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_edge(START, <span style="color:#e6db74">&#34;read_email&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add edges - defining the flow</span>
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_edge(<span style="color:#e6db74">&#34;read_email&#34;</span>, <span style="color:#e6db74">&#34;classify_email&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add conditional branching from classify_email</span>
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_conditional_edges(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;classify_email&#34;</span>,
</span></span><span style="display:flex;"><span>    route_email,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;spam&#34;</span>: <span style="color:#e6db74">&#34;handle_spam&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;legitimate&#34;</span>: <span style="color:#e6db74">&#34;draft_response&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add the final edges</span>
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_edge(<span style="color:#e6db74">&#34;handle_spam&#34;</span>, END)
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_edge(<span style="color:#e6db74">&#34;draft_response&#34;</span>, <span style="color:#e6db74">&#34;notify_mr_hugg&#34;</span>)
</span></span><span style="display:flex;"><span>email_graph<span style="color:#f92672">.</span>add_edge(<span style="color:#e6db74">&#34;notify_mr_hugg&#34;</span>, END)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Compile the graph</span>
</span></span><span style="display:flex;"><span>compiled_graph <span style="color:#f92672">=</span> email_graph<span style="color:#f92672">.</span>compile()
</span></span></code></pre></div><p>执行 Application：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e"># Example legitimate email</span>
</span></span><span style="display:flex;"><span>legitimate_email <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;sender&#34;</span>: <span style="color:#e6db74">&#34;john.smith@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;subject&#34;</span>: <span style="color:#e6db74">&#34;Question about your services&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;body&#34;</span>: <span style="color:#e6db74">&#34;Dear Mr. Hugg, I was referred to you by a colleague and I&#39;m interested in learning more about your consulting services. Could we schedule a call next week? Best regards, John Smith&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example spam email</span>
</span></span><span style="display:flex;"><span>spam_email <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;sender&#34;</span>: <span style="color:#e6db74">&#34;winner@lottery-intl.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;subject&#34;</span>: <span style="color:#e6db74">&#34;YOU HAVE WON $5,000,000!!!&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;body&#34;</span>: <span style="color:#e6db74">&#34;CONGRATULATIONS! You have been selected as the winner of our international lottery! To claim your $5,000,000 prize, please send us your bank details and a processing fee of $100.&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Process the legitimate email</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Processing legitimate email...&#34;</span>)
</span></span><span style="display:flex;"><span>legitimate_result <span style="color:#f92672">=</span> compiled_graph<span style="color:#f92672">.</span>invoke({
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;email&#34;</span>: legitimate_email,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;is_spam&#34;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;spam_reason&#34;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;email_category&#34;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;email_draft&#34;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;messages&#34;</span>: []
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Process the spam email</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Processing spam email...&#34;</span>)
</span></span><span style="display:flex;"><span>spam_result <span style="color:#f92672">=</span> compiled_graph<span style="color:#f92672">.</span>invoke({
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;email&#34;</span>: spam_email,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;is_spam&#34;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;spam_reason&#34;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;email_category&#34;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;email_draft&#34;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;messages&#34;</span>: []
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>可视化图</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>compiled_graph<span style="color:#f92672">.</span>get_graph()<span style="color:#f92672">.</span>draw_mermaid_png()
</span></span></code></pre></div><p>这展示了如何通过 LangGraph 利用 LLMs，提现了 LangGraph 的 <strong>orchestrate</strong> 能力，即编排复杂工作流程的能力。</p>
<h1 id="问题">问题<a hidden class="anchor" aria-hidden="true" href="#问题">#</a></h1>
<p><code>model = ChatOpenAI(api_key=&quot;your OpenAI_API_Key&quot;, temperature=0)</code> 你需要有 openai 的 API key。</p>
<h2 id="使用本地的-ollama-部署的-llm">使用本地的 Ollama 部署的 LLM<a hidden class="anchor" aria-hidden="true" href="#使用本地的-ollama-部署的-llm">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 11434 是ollama 服务的端口</span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;http_proxy&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://127.0.0.1:11434&#34;</span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;https_proxy&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://127.0.0.1:11434&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定你本地 Ollama 模型的名称和本地API地址</span>
</span></span><span style="display:flex;"><span>infer_server_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://localhost:11434/v1&#34;</span>
</span></span><span style="display:flex;"><span>model_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;deepseek-r1:1.5b&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> ChatOllama(
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">=</span>model_name,
</span></span><span style="display:flex;"><span>    openai_api_base<span style="color:#f92672">=</span>infer_server_url,
</span></span><span style="display:flex;"><span>    openai_api_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;none&#34;</span>,  <span style="color:#75715e"># Ollama 不需要真实API Key，设置为 none</span>
</span></span><span style="display:flex;"><span>    temperature<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>执行脚本之前，需要确保Ollama server已经开启。</p>
<h2 id="确实使用了-local-llm但是输出似乎不符合预期">确实使用了 local LLM，但是输出似乎不符合预期？<a hidden class="anchor" aria-hidden="true" href="#确实使用了-local-llm但是输出似乎不符合预期">#</a></h2>
<h2 id="kaq-只有命令行的-linux-不能显示-graph-结构如何查看">KAQ: 只有命令行的 Linux 不能显示 Graph 结构，如何查看？<a hidden class="anchor" aria-hidden="true" href="#kaq-只有命令行的-linux-不能显示-graph-结构如何查看">#</a></h2>
<p>输出 mermaid 源码，然后拷贝到在线的 mermaid 编辑器中查看。</p>
<h2 id="kaq-充分使用了-jetson-的-cpugpu-没有使用上">KAQ: 充分使用了 Jetson 的 CPU，GPU 没有使用上？<a hidden class="anchor" aria-hidden="true" href="#kaq-充分使用了-jetson-的-cpugpu-没有使用上">#</a></h2>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://ashburnLee.github.io/blog-2-hugo/tags/agent/">Agent</a></li>
      <li><a href="https://ashburnLee.github.io/blog-2-hugo/tags/langgraph/">LangGraph</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://ashburnLee.github.io/blog-2-hugo/">Junhui&#39;s Journal 2</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
